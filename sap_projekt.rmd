---
title: "Statistička analiza podataka - projekt"
author: "Sapunanje"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
editor_options:
  markdown:
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(base)
library(dbplyr)
library(data.table)
library(datasets)
library(magrittr)
library(tidyr)
library(dplyr)
library(readr)
library(stringr)
library(lubridate)
library(ggplot2)
```

## **Statistika nogometaša engleske Premier lige**

#### Studenti: Karlo Boroš, Petar Novak, Vlado Perković i Mislav Rendulić

### **1. Uvod**

Ovaj projekt iz kolegija Statistička analiza podataka radili smo pod
vodstvom asistenta *insert_name*. Ovaj seminar ćemo podijeliti u par
dijelova:

1.  Uvod
2.  Osnovna prilagodba podataka
3.  Generalne informacije o podacima
4.  *XY*-test
5.  *YZ*-test
6.  *ZX*-test
7.  *XZ*-test
8.  Rezultati

Imali smo sreće i dobili smo upravo zadatak koji smo i priželjkivali.

**Cilj** ovoga projekta je uzeti dane podatke i iz njih probati izvući
zaključke i faktore koji mogu utjecati na rezultat, broj golova i sl.
Naravno, nije potrebno naglasiti važnost korištenja ispravnih testova te
dobivanje rezultata koji su validni.

### **2. Osnovna prilagodba podataka**

Podatke je prvo potrebno učitati. Bitno je dobro ih proučiti kako ne
bismo slučajno pogriješili u nekom zaključku. Nakon dobre analize možemo
krenuti sa našim zadacima.

**izbrisati kasnije** *napomena ostatku ekipe: spremio sam podatke kao
dataset.csv jer je ime dugo i ne ocitava š pa je ovo najjednostavnije*

#poslije dodati include = FALSE, za sad nek ostane da vidimo sve sta
treba

```{r }
nogometasi <- read.csv('dataset.csv', encoding = "UTF-8")
nogometasi$Nation <- str_sub(nogometasi$Nation, -3)
head(nogometasi)
str(nogometasi)
```

Nakon enkodiranja početnih podataka, postajala su odstupanja od stvarnih
imena kod nekih igrača pa smo ta imena ručno ispravili.

```{r include=FALSE}
#utf-8 encoding
#imena <- c("Halil Dervişoğlu", "Michał Karbownik", "Matěj Vydra", "Mateo Kovačić",  "Luka Milivojević", "Asmir Begović", "Çağlar Söyüncü", "Eldin Jakupović", "İlkay Gündoğan", "Nemanja Matić", "Przemysław Płacheta", "Łukasz Fabiański", "Tomáš Souček", "Nikola Vlašić")



#ako nema elegantnijeg nacina nek ovo ostane

nogometasi$Player[nogometasi$Player == "Halil Dervi?o?lu"] <- "Halil Dervişoğlu"
nogometasi$Player[nogometasi$Player == "?lkay Gündo?an"] <- "İlkay Gündoğan"
nogometasi$Player[nogometasi$Player == "?ukasz Fabia?ski"] <- "Łukasz Fabiański"
nogometasi$Player[nogometasi$Player == "Asmir Begovi?"] <- "Asmir Begović"
nogometasi$Player[nogometasi$Player == "Ça?lar Söyüncü"] <- "Çağlar Söyüncü"
nogometasi$Player[nogometasi$Player == "Eldin Jakupovi?"] <- "Eldin Jakupović"
nogometasi$Player[nogometasi$Player == "Luka Milivojevi?"] <- "Luka Milivojević"
nogometasi$Player[nogometasi$Player == "Mat?j Vydra"] <- "Matěj Vydra"
nogometasi$Player[nogometasi$Player == "Mateo Kova?i?"] <- "Mateo Kovačić"
nogometasi$Player[nogometasi$Player == "Micha? Karbownik"] <- "Michał Karbownik"
nogometasi$Player[nogometasi$Player == "Nemanja Mati?"] <- "Nemanja Matić"
nogometasi$Player[nogometasi$Player == "Nikola Vla\u009ai?"] <- "Nikola Vlašić"
nogometasi$Player[nogometasi$Player == "Przemys?aw P?acheta"] <- "Przemysław Płacheta"
nogometasi$Player[nogometasi$Player == "Tomá\u009a Sou?ek"] <- "Tomáš Souček"



```

Konverzija odigranih minuta iz char u numeric:

```{r}
nogometasi$Min <- as.numeric(gsub(",", "", nogometasi$Min))
```


### **3. Pregled sezone**

```{r include=FALSE}
klubovi <- nogometasi$Team %>% unique()
najbolji_strijelci <- slice_max(nogometasi, Gls, n=5) %>% select(Player, Team, Gls, Gls.1) %>% rename("Gls per 90 min" = "Gls.1")
najbolji_asistenti <- slice_max(nogometasi, Ast, n=5) %>% select(Player, Team, Ast, Ast.1) %>% rename("Ast per 90 min" = "Ast.1")
```

Ekipe koje su se natjecale u Premier Ligi u sezonu 2021/2022

```{r}
#as_tibble(klubovi)
klubovi
#cat('Preko rownames mozda nastimati da ne pise "value" + odluciti jel bi ispisali preko tibble-a ili obicno')
```

#### Najbolji strijelci

```{r}
najbolji_strijelci
```

#### Najbolji asistenti

```{r}
najbolji_asistenti
```

#### Pozicije igrača

Vizualizacija razdiobe igrača po pozicijama:

```{r}
nogometasi %>% select(Pos) %>% summarise(uniPos = ifelse(Pos == "DF,FW", "FW,DF", ifelse(Pos == "MF,FW", "FW,MF", ifelse(Pos == "DF,MF", "MF,DF", Pos)))) %>% arrange(uniPos) -> popravak
#c("GK","DF", "MF,DF", "MF", "FW,MF", "FW,DF", "FW")
barplot(table(popravak), xlab = "Pozicije", ylab = "frekvencija")
```

Primijetimo veliki broj obrambenih igrača što i ima smisla kada
pogledamo da ekipe najčešće igraju s 4 igrača u obrani. Neki igrači su
igrali pozicije beka i napadačkog krila pa spadaju u skupinu "FW,DF"
koja je na prvi pogled dosta neuobičajena.

#### Godine igrača

```{r}
distrStarosti <- hist(nogometasi$Age,
                      breaks = 20,
                      main="Razdioba starosti igrača",
                      xlab="Starost",
                      ylab='Frekvencija'
                      )
```

```{r}
x <- nogometasi %>% filter(!is.na(X90s) & X90s >= 9.5)
distrStarosti <- hist(x$Age,
                      breaks = 20,
                      main="Starost igrača sa 25%+ minutaze",
                      xlab="Starost",
                      ylab='Frekvencija'
                      )
```

### **4.**

#### **Postoji li razlika u broju odigranih minuta mladih igrača (do 25 godina) među premierligaškim ekipama?**

Podijelimo igrače...

```{r}
mladi <- nogometasi %>% filter(Age <= 25)
cat("Broj mladih igrača do 25 godina iznosi: ", nrow(mladi), "\n")
stari <- nogometasi %>% filter(Age > 25)
cat("Broj igrača iznad 25 godina iznosi: ", nrow(stari))
```

Vizualizirajmo podjelu igrača u samim klubovima:

```{r}
nogometasi_god <- nogometasi %>% summarise(mladi = ifelse(Age <= 25, 1, 0), Team) %>% group_by(Team) %>% summarise(mladi = sum(mladi, na.rm = T), stari = n() - mladi) %>% pivot_longer(cols = mladi:stari, names_to = "kategorija")

ggplot(nogometasi_god, aes(x=Team, y=value, fill=kategorija)) +
    geom_bar(stat="identity", position="dodge") +
    theme(axis.text.x = element_text(angle = 90)) 
  #scale_fill_brewer(palette = "Set1")
```

Vidimo da klubovi pretežno nastoje priključivati mlađe igrače u ekipu uz
iznimke timova Burnley i Newcastle United.

Pogledajmo sada koliko te iste mlade igrače timovi zapravo i koriste...

```{r}
nogometasi_min <- nogometasi %>% filter(!is.na(Age)) %>% summarise(Team, kategorija = ifelse(Age <= 26, "mladi", "stari"), minutaza = X90s*90) %>% group_by(Team, kategorija) %>%  summarise(Team, kategorija, ukupno = sum(minutaza, na.rm = T)) %>% unique()

ggplot(nogometasi_min, aes(x=Team, y=ukupno, fill=kategorija)) +
    geom_bar(stat="identity", position="dodge") +
    theme(axis.text.x = element_text(angle = 90)) 
```
Kod analize u obzir ćemo uzeti mlade igrače koji su upisali barem 90 minuta.

```{r}
mladi90 <- nogometasi %>% filter(Age <= 25 & Min >= 90)
```

Pogledajmo koliko su u prosjeku klubovi davali minuta svojim mladim igračima

```{r}
boxplot(mladi90$Min ~ mladi90$Team, xlab = "Team", ylab = "Minutes played")
abline(h=mean(mladi90$Min), col = "Red")

```
Testirat ćemo homogenost varijance raspodijele minuta mladih igraca po klubovima:
```{r}
bartlett.test(mladi90$Min ~ mladi90$Team)
```
Sada je potrebno testirati normalnost distribucije odigranih minuta za igrače do 25 godina ukupno i po klubovima: 
```{r}
qqnorm(mladi90$Min, pch = 1, frame = FALSE,main='Odigrane minute za igrače do 25 godina')
qqline(mladi90$Min, col = "steelblue", lwd = 2)
```
```{r}
require(nortest)

lillie.test(mladi90$Min[mladi90$Team == "Arsenal"])
lillie.test(mladi90$Min[mladi90$Team == "Aston Villa"])
lillie.test(mladi90$Min[mladi90$Team == "Brentford"])
lillie.test(mladi90$Min[mladi90$Team == "Brighton & Hove Albion"])
lillie.test(mladi90$Min[mladi90$Team == "Burnley"])
lillie.test(mladi90$Min[mladi90$Team == "Chelsea"])
lillie.test(mladi90$Min[mladi90$Team == "Crystal Palace"])
lillie.test(mladi90$Min[mladi90$Team == "Leeds United"])
lillie.test(mladi90$Min[mladi90$Team == "Leicester City"])
lillie.test(mladi90$Min[mladi90$Team == "Liverpool"])
lillie.test(mladi90$Min[mladi90$Team == "Manchester City"])
lillie.test(mladi90$Min[mladi90$Team == "Manchester United"])
lillie.test(mladi90$Min[mladi90$Team == "Newcastle United"])
lillie.test(mladi90$Min[mladi90$Team == "Norwich City"])
lillie.test(mladi90$Min[mladi90$Team == "Southampton"])
lillie.test(mladi90$Min[mladi90$Team == "Tottenham Hotspur"])
lillie.test(mladi90$Min[mladi90$Team == "Watford"])
lillie.test(mladi90$Min[mladi90$Team == "West Ham United"])
lillie.test(mladi90$Min[mladi90$Team == "Wolverhampton Wanderers"])
```
Na razini znacajnosti od 5% jedino Liverpool pravi probleme kod normalnosti.
Iako varijanca i sredina ne odudaraju, uzorak ima izražene stršeće vrijednosti (Trent i Jota)

```{r}
(mladi90 %>% filter(Team == "Liverpool"))[, c('Player', 'Min')]

mladi90bezL <- mladi90 %>% filter(Team != "Liverpool")
```
Sada kada smo pretpostavili homogenost varijance, normalnost i nezavisnost provest ćemo ANOVA test:
  Nulta hipoteza: Raspodijela minuta igračima do 25 godina se ne razlikuje po klubovima
  Alternativna hipoteza: Raspodijela minuta igračima do 25 godina razlikuje se u barem jednom klubu
  alpha = 0.05

```{r}
anova(lm(Min ~ Team, data = mladi90bezL))
```

#### **Zaključci:**
Ne odbacujemo nultu hipotezu da se raspodijela minuta razlikuje po klubovima.

Liverpool nismo uvrstili u test jer nismo mogli pretpostaviti normalnost, ali ni za tu ekipu ne možemo reći da značajno odstupa od prosjeka.
```{r}
mean(mladi90$Min[mladi90$Team == "Liverpool"])
mean(mladi90$Min)
```

...

### **5.**

#### **Dobivaju li u prosjeku više žutih kartona napadači ili igrači veznog reda?**

Uzmimo za početak prosječne vrijednosti dobijenih žutih kartona kao
motivaciju za statističko ispitivanje. Budući da se neki igrači smatraju
i veznjacima i napadačima, njih nećemo ubrajati u ispitivanje kako bi
mogli pretpostaviti **nezavisnost**.

Moramo pripaziti i na činjenicu da postoji podosta igrača s vrlo malo
minuta odigrano, stoga ima smisla gledati igrače koji su u cijeloj
sezoni sveukupno barem 25% minuta odigrali.

//samo napadaci i samo veznjaci

```{r}
#pitanje: ima li smisla ukljucivat MF,DF pod veznjake kao i FW,DF pod napadače
veznjaci <- nogometasi %>% filter(Pos == "MF" & !is.na(X90s) & X90s >= 9.5)
napadaci <- nogometasi %>% filter(Pos == "FW" & !is.na(X90s) & X90s >= 9.5)
cat("Prosječan broj žutih kartona igrača veznog reda iznosi: ", mean(veznjaci$CrdY, na.rm = T), "\n")
cat("Prosječan broj žutih kartona napadača iznosi: ", mean(napadaci$CrdY, na.rm = T))

```

// napadaci su "FW", "FW,MF", "FW, DF"

// veznjaci su "MF", "MF,FW", "MF,DF"

```{r}
#pitanje: ima li smisla ukljucivat MF,DF pod veznjake kao i FW,DF pod napadače
veznjaci <- nogometasi %>% filter(Pos == "MF" | Pos == "MF,FW" | Pos == "MF,DF") %>% filter(!is.na(X90s) & X90s >= 9.5)
napadaci <- nogometasi %>% filter(Pos == "FW" | Pos == "FW,MF" | Pos == "FW,DF") %>% filter(!is.na(X90s) & X90s >= 9.5)
cat("Prosječan broj žutih kartona igrača veznog reda iznosi: ", mean(veznjaci$CrdY, na.rm = T), "\n")
cat("Prosječan broj žutih kartona napadača iznosi: ", mean(napadaci$CrdY, na.rm = T))

```

Vizualiziramo li podatke pomoću box plota:

```{r}
boxplot(veznjaci$CrdY, napadaci$CrdY, 
        names = c('broj žutih kartona veznih igrača','broj žutih kartona napadača'),
        main='Box plot raspodjele žutih kartona među veznjacima i napadačima')
```

dobijemo bolju sliku stvarne raspodjele žutih kartona u kojoj vidimo
neke indikacije da bi mogla postojati razlika u broju žutih kartona.
Ovakvo ispitivanje bismo mogli provesti klasičnim t-testom, no prvo se
moramo uvjeriti da raspodjele kartona dolaze iz normalne razdiobe.

Normalnost ćemo provjeriti histogramom i qq plotom.

```{r}
hist(veznjaci$CrdY, 
     breaks=seq(min(veznjaci$CrdY, na.rm = T),max(veznjaci$CrdY, na.rm = T)+1,0.25),
     main='Histogram količine žutih kartona igrača veznog reda',
     xlab='broj žutih kartona')
```

```{r}
qqnorm(veznjaci$CrdY, pch = 1, frame = FALSE,main='igrači veznog reda')
qqline(veznjaci$CrdY, col = "steelblue", lwd = 2)
```

```{r}
hist(napadaci$CrdY, 
     breaks=seq(min(napadaci$CrdY, na.rm = T),max(napadaci$CrdY, na.rm = T)+1,0.25),
     main='Histogram količine žutih kartona napadača',
     xlab='broj žutih kartona')
```

```{r}
qqnorm(napadaci$CrdY, pch = 1, frame = FALSE,main='napadači')
qqline(napadaci$CrdY, col = "steelblue", lwd = 2)
```

Provjeravamo jesu li varijance uzoraka značajno različite:

```{r}
cat("Varijanca broja žutih kartona kod veznjaka iznosi: ", var(veznjaci$CrdY), "\n")

cat("Varijanca broja žutih kartona kod napadača iznosi: ", var(napadaci$CrdY))
```

ispitajmo...

```{r}
var.test(veznjaci$CrdY, napadaci$CrdY)
```

Ne odbacujemo H0 koja kaže da su varijance jednake. Dakle koristit ćemo
**t-test za dva uzorka s pretpostavkom jednakih varijanci**.

H0: broj žutih kartona između veznjaka i napadača je jednak.

H1: broj žutih kartona kod veznjaka veći je od onog kod napadača.

Odabir H1 motiviran je saznanjem da očekujemo da veznjaci imaju više
žutih kartona.

```{r}
t.test(veznjaci$CrdY, napadaci$CrdY, alt = "greater", var.equal = TRUE)
#izveo sam i za two.sided, outcome je isti
```

Budući da je p-value jako malen, možemo odbaciti H0 u korist H1.

#### **Zaključci:**

Na razini pouzdanosti od 95% odbacujemo H0 u korist H1 odnosno
zaključujemo da je broj žutih kartona kod veznjaka veći od onog kod
napadača.

### **6.**

Što je zapravo uspješnost igrača? To je pitanje kojim smo se prvotno
morali baviti i secirati što čini dobrog igrača ovisno o pozicijama.

G/A bez golmana i branica

```{r}
nog <- nogometasi %>% filter(Pos == "FW" | Pos == "FW,MF" | Pos == "MF,FW" | Pos == "MF") %>% filter(X90s > 19)
dobri <- nog %>% filter(Ast > 6 | Gls > 12)
losi <- nog %>% filter(Ast <= 6 & Gls <= 12)
ggplot(dobri, aes(x = Gls, y = Ast)) + geom_jitter(width = 0.4, height = 0.4,) + geom_text(aes(label = Player), check_overlap = T, size = 2.5) + geom_jitter(data = losi, aes(x = Gls, y = Ast), width = 0.3, height = 0.3)
```

xG/xA bez golmana i branica

```{r}
dobrixG <- nog %>% filter(xG > 9.5 | xA > 5)
losixG <- nog %>% filter(xG <= 9.5 & xA <= 5)
ggplot(dobrixG, aes(x = xG, y = xA)) + geom_jitter(width = 0.3, height = 0.3) + geom_text(aes(label = Player), check_overlap = T, size = 2.5) + geom_jitter(data = losixG,aes(x = xG, y = xA), width = 0.3, height = 0.3 )
```

Gper90/Aper90 bez golmana i branica

```{r}
ggplot(nog, aes(x = Gls.1, y = Ast.1)) + geom_jitter(width = 0.3, height = 0.3,) + geom_text(aes(label = Player), check_overlap = T, size = 2.5)
```

**blablabla** ...

```{r}

```

#### **Zaključci:**

...

### **7.**

Svi koji prate nogomet malo detaljnije znaju čiji igrači se cijene.
Brazilci su najbolji dribleri, Španjolci najbolji u tiki-taki, Hrvati
najbolji u penalima, ali u Engleskoj su najbolji Englezi. Javnost to
zove *"English tax"* i time se cilja na činjenicu kako engleski klubovi
skuplje plaćaju i prodaju domaće igrače u odnosu na strane. Je li to
opravdano, pokazat će nam naš xz-test. Koristit ćemo ga jer **razlog** i
napokon ćemo saznati doprinose li oni sveukupnom uspjehu tima ili je to
još jedna preuveličana engleska nogometna bajka. ...

```{r}

```

#### **Zaključci:**

...

### **8. Rezultati**

...

...
